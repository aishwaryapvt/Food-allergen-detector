<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü•ó Food Allergen Detector</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      background: white;
      width: 90%;
      max-width: 700px;
      margin: 40px auto;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 30px 40px;
      animation: fadeIn 0.6s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: vertical;
      font-size: 16px;
      box-sizing: border-box;
      margin-bottom: 15px;
    }

    .btn {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background-color: #27ae60;
    }

    input[type="file"] {
      margin-top: 10px;
    }

    #uploaded-image {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      display: none;
    }

    .results {
      margin-top: 25px;
      padding: 20px;
      background: #fafafa;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      animation: fadeIn 0.5s ease;
    }

    .progress-container {
      margin-bottom: 12px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .progress-bar {
      height: 12px;
      border-radius: 6px;
      background: #e0e0e0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.5s ease;
    }

    .detected {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .chip {
      background: #dff9fb;
      color: #2c3e50;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .chip:hover {
      transform: scale(1.05);
    }

    .loading {
      text-align: center;
      color: #555;
      font-style: italic;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>ü•ó Food Allergen Detector</h1>
    <p>Enter ingredients manually or upload a product label image for automatic detection:</p>

    <textarea id="ingredients" placeholder="e.g., wheat flour, milk solids, egg, sugar"></textarea>
    <button class="btn" onclick="detectAllergens()">üîç Detect Allergens</button>
    <br><br>

    <input type="file" accept="image/*" capture="environment" id="imageInput" onchange="previewImage(event)">
    <img id="uploaded-image">

    <div class="results" id="results" style="display:none;">
      <h2>Results:</h2>
      <div id="detected-allergens" class="detected"></div>
      <div id="confidence-bars"></div>
    </div>
  </div>

  <script>
    async function detectAllergens() {
      const ingredients = document.getElementById("ingredients").value.trim();
      const resultsDiv = document.getElementById("results");
      const bars = document.getElementById("confidence-bars");
      const detectedDiv = document.getElementById("detected-allergens");

      if (!ingredients) {
        alert("‚ö†Ô∏è Please enter ingredient text first or upload a label image.");
        return;
      }

      // Show loading state
      resultsDiv.style.display = "block";
      detectedDiv.innerHTML = "";
      bars.innerHTML = "";
      resultsDiv.querySelector("h2").innerText = "‚è≥ Detecting allergens...";

      try {
        const response = await fetch("http://127.0.0.1:8000/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ingredients }),
        });

        if (!response.ok) throw new Error("Server error: " + response.status);
        const data = await response.json();
        const scores = data.result.confidence_scores;
        const detected = data.result.detected_allergens;

        // Clear loading message
        resultsDiv.querySelector("h2").innerText = "Results:";

        // Show detected allergens
        detectedDiv.innerHTML = detected.length
          ? detected.map(a => `<span class='chip'>${a}</span>`).join("")
          : "<p>No strong allergens detected.</p>";

        // Create confidence bars
        for (const [allergen, score] of Object.entries(scores)) {
          const percent = (score * 100).toFixed(1);
          const barColor = score > 0.6 ? "#e74c3c" : score > 0.3 ? "#f1c40f" : "#2ecc71";
          const container = document.createElement("div");
          container.className = "progress-container";
          container.innerHTML = `
            <div class="progress-label">
              <span>${allergen}</span>
              <span>${percent}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percent}%; background-color: ${barColor};"></div>
            </div>
          `;
          bars.appendChild(container);
        }
      } catch (err) {
        resultsDiv.querySelector("h2").innerText = "‚ùå Error";
        detectedDiv.innerHTML = `<p style='color:red;'>${err.message}</p>`;
      }
    }

    // OCR from image
    function previewImage(event) {
      const file = event.target.files[0];
      const img = document.getElementById("uploaded-image");
      const textarea = document.getElementById("ingredients");

      if (file) {
        const reader = new FileReader();
        reader.onload = async e => {
          img.src = e.target.result;
          img.style.display = "block";
          textarea.value = "üïµÔ∏è Extracting text from image... please wait...";

          try {
            const { data: { text } } = await Tesseract.recognize(file, 'eng', {
              logger: info => console.log(info),
            });

            textarea.value = text.trim() || "‚ö†Ô∏è No readable text found in image.";
          } catch {
            textarea.value = "‚ö†Ô∏è Failed to extract text from image.";
          }
        };
        reader.readAsDataURL(file);
      }
    }
  </script>
</body>
</html>
